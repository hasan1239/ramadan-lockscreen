<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico">
  <meta name="theme-color" content="#050c18">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <title>Prayerly - Prayer Times</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Lato', sans-serif;
      background: linear-gradient(180deg, #050c18, #0a1628 40%, #0d1f15);
      color: #e8e8e8;
      min-height: 100vh;
      padding: 16px 16px;
      position: relative;
      overflow-x: hidden;
    }

    /* Gradient overlays */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 50% -10%, #1a4a3a, transparent 60%),
        radial-gradient(ellipse at 100% 50%, #0d2d40, transparent 50%),
        radial-gradient(ellipse at 0% 80%, #1a2a0d, transparent 50%);
      z-index: 0;
      opacity: 0.5;
    }

    /* Islamic pattern */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(60deg, transparent, transparent 28px, rgba(212,175,55,0.02) 28px, rgba(212,175,55,0.02) 29px),
        repeating-linear-gradient(-60deg, transparent, transparent 28px, rgba(212,175,55,0.02) 28px, rgba(212,175,55,0.02) 29px);
      z-index: 1;
      pointer-events: none;
    }

    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.7; }
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    .download-btn {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      border: none;
      color: #0a0a0a;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      width: 100%;
      text-align: center;
      margin-top: 6px;
      margin-bottom: 0;
    }

    .download-btn:hover {
      background: linear-gradient(135deg, #f0cd5a, #d4af37);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .download-btn:active {
      transform: translateY(0);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }

    .btn-row .download-btn {
      margin-top: 0;
      margin-bottom: 0;
    }

    .share-btn {
      background: transparent;
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .share-btn:hover {
      background: rgba(212, 175, 55, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
    }

    .share-btn:active {
      transform: translateY(0);
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 18px;
    }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      color: #d4af37;
      margin-bottom: 6px;
      font-weight: 700;
      line-height: 1.2;
    }

    .date-line {
      font-size: 0.85rem;
      color: #a0a0a0;
      margin-bottom: 4px;
    }

    .hijri-line {
      font-family: 'Amiri', serif;
      font-size: 0.95rem;
      color: #90c090;
      margin-bottom: 10px;
    }

    /* View toggle */
    .view-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .toggle-container {
      position: relative;
      display: flex;
      padding: 4px;
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(8px);
      border-radius: 10px;
      border: 1px solid rgba(100, 116, 139, 0.3);
      width: 100%;
    }

    .toggle-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: calc(50% - 4px);
      height: calc(100% - 8px);
      background: linear-gradient(135deg, #d4af37, #b8941f);
      border-radius: 8px;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
    }

    .toggle-slider.monthly {
      transform: translateX(100%);
    }

    .toggle-btn {
      position: relative;
      flex: 1;
      padding: 10px 20px;
      font-size: 0.85rem;
      font-weight: 500;
      color: #94a3b8;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.3s ease;
      z-index: 1;
      text-align: center;
    }

    .toggle-btn.active {
      color: #0a0a0a;
      font-weight: 700;
    }

    .toggle-btn:hover:not(.active) {
      color: #e2e8f0;
    }

    /* Content sections */
    .view-container {
      display: none;
    }

    .view-container.active {
      display: block;
    }

    /* Today's times table */
    .times-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 14px;
      padding: 12px 16px 6px 16px;
      margin-bottom: 20px;
    }

    .section-title {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      color: #d4af37;
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
    }

    .times-table {
      width: 100%;
    }

    .time-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .time-row:last-child {
      border-bottom: none;
    }

    .time-label {
      font-size: 1rem;
      color: #c0c0c0;
      font-weight: 400;
    }

    .time-value {
      font-family: 'Cinzel', serif;
      font-size: 1.15rem;
      color: #d4af37;
      font-weight: 600;
    }

    /* Divider between sections */
    .gold-divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 16px 0;
    }

    .gold-divider .line {
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, #d4af37, transparent);
    }

    .gold-divider .diamond {
      width: 8px;
      height: 8px;
      background: #d4af37;
      transform: rotate(45deg);
      margin: 0 12px;
    }

    /* Lockscreen-style layout */
    .lockscreen-section {
      margin: 12px 0;
    }

    .section-banner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    .banner-item {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08));
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 10px;
      padding: 12px 10px;
      text-align: center;
    }

    .banner-label {
      font-family: 'Lato', sans-serif;
      font-size: 0.75rem;
      color: #a0a0a0;
      margin-bottom: 6px;
      font-weight: 400;
    }

    .banner-time {
      font-family: 'Cinzel', serif;
      font-size: 1.35rem;
      color: #d4af37;
      font-weight: 700;
    }

    /* Flip card for sehri banner */
    .flip-card {
      perspective: 600px;
      cursor: pointer;
    }

    .flip-card-inner {
      position: relative;
      transition: transform 0.5s ease;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      position: relative;
    }

    .flip-card-back {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: rotateY(180deg);
    }

    .flip-hint {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 0.65rem;
      color: rgba(212, 175, 55, 0.5);
      line-height: 1;
    }

    .times-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .time-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .time-item:last-child {
      border-bottom: none;
    }

    .time-item .time-label {
      font-size: 0.9rem;
      color: #c0c0c0;
      font-weight: 400;
    }

    .time-item .time-value {
      font-family: 'Cinzel', serif;
      font-size: 1.05rem;
      color: #d4af37;
      font-weight: 600;
    }

    /* Next prayer highlight */
    .time-item.next-prayer {
      background: rgba(212, 175, 55, 0.08);
      border-left: 3px solid #d4af37;
      margin: 0 -12px;
      padding-left: 12px;
      padding-right: 12px;
      border-radius: 6px;
    }

    .banner-item.next-prayer {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.25), rgba(212, 175, 55, 0.15));
      border-color: rgba(212, 175, 55, 0.5);
      box-sizing: border-box;
      min-width: 0;
    }

    .countdown {
      font-family: 'Lato', sans-serif;
      font-size: 0.7rem;
      color: #90c090;
      font-weight: 400;
      margin-left: 6px;
    }

    @media (max-width: 767px) {
      .banner-label .countdown {
        display: block;
        margin-left: 0;
      }
    }

    /* Monthly calendar view */
    .calendar-grid {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 14px;
      padding: 20px;
      overflow-x: auto;
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .calendar-table thead th {
      font-family: 'Cinzel', serif;
      color: #d4af37;
      font-weight: 600;
      padding: 10px 8px;
      text-align: center;
      border-bottom: 2px solid rgba(212, 175, 55, 0.3);
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .calendar-table tbody td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #c0c0c0;
      white-space: nowrap;
    }

    .calendar-table tbody tr:last-child td {
      border-bottom: none;
    }

    .calendar-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .calendar-table tbody tr.today {
      background: rgba(212, 175, 55, 0.1);
    }

    .calendar-table tbody tr.today td {
      color: #d4af37;
      font-weight: 600;
    }

    .calendar-table .section-header {
      font-size: 0.7rem;
      color: rgba(212, 175, 55, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid rgba(212, 175, 55, 0.15);
      padding: 6px 8px;
    }

    .calendar-table .section-divider {
      border-left: 1px solid rgba(212, 175, 55, 0.2);
    }

    .date-col {
      color: #a0a0a0;
      font-weight: 500;
    }

    /* Install banner */
    .install-banner {
      background: rgba(212, 175, 55, 0.08);
      border: 1px solid rgba(212, 175, 55, 0.25);
      border-radius: 10px;
      padding: 14px 16px 48px 16px;
      margin-top: 14px;
      display: none;
      position: relative;
    }

    .install-banner.visible {
      display: block;
    }

    .install-banner-text {
      font-size: 0.85rem;
      color: #c0c0c0;
      line-height: 1.5;
      padding-right: 24px;
    }

    .install-banner-text strong {
      color: #d4af37;
    }

    .install-btn {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      border: none;
      color: #0a0a0a;
      padding: 8px 18px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      position: absolute;
      bottom: 14px;
      right: 16px;
    }

    .install-btn:hover {
      background: linear-gradient(135deg, #f0cd5a, #d4af37);
    }

    .install-dismiss {
      background: none;
      border: none;
      color: #808080;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      position: absolute;
      top: 12px;
      right: 14px;
    }

    .install-dismiss:hover {
      color: #c0c0c0;
    }

    /* Loading & error states */
    .loading, .error {
      text-align: center;
      padding: 60px 20px;
      font-size: 1.1rem;
      color: #a0a0a0;
    }

    .error {
      color: #e88080;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #808080;
      font-size: 0.85rem;
    }

    /* Desktop styles */
    @media (min-width: 768px) {
      body {
        padding: 40px 30px;
      }

      h1 {
        font-size: 2.5rem;
      }

      .date-line {
        font-size: 1.05rem;
      }

      .hijri-line {
        font-size: 1.15rem;
      }

      .toggle-btn {
        padding: 10px 24px;
        font-size: 0.9rem;
      }

      .times-card {
        padding: 35px 40px;
      }

      .time-row {
        padding: 15px 0;
      }

      .time-label {
        font-size: 1.1rem;
      }

      .time-value {
        font-size: 1.3rem;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .banner-item {
        padding: 22px 18px;
      }

      .banner-label {
        font-size: 0.95rem;
        margin-bottom: 10px;
      }

      .banner-time {
        font-size: 1.85rem;
      }

      .flip-hint {
        font-size: 0.75rem;
        top: 8px;
        right: 10px;
      }

      .time-item {
        padding: 16px 0;
      }

      .time-item .time-label {
        font-size: 1.1rem;
      }

      .time-item .time-value {
        font-size: 1.3rem;
      }

      .countdown {
        font-size: 0.8rem;
      }

      .btn-row {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 15px;
      }

      .download-btn {
        width: auto;
      }

      .calendar-table {
        font-size: 0.9rem;
      }

      .calendar-table thead th {
        font-size: 0.85rem;
        padding: 12px 10px;
      }

      .calendar-table tbody td {
        padding: 12px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>

  <div class="container">
    <div id="content">
      <div class="loading">Loading prayer times...</div>
    </div>

    <div class="install-banner" id="installBanner">
      <div class="install-banner-text" id="installText"></div>
      <button class="install-btn" id="installBtn" style="display:none;"></button>
      <button class="install-dismiss" id="installDismiss" title="Dismiss">&times;</button>
    </div>

    <footer>
      <p>Updates daily at 4:30am GMT · © Prayerly <span id="appVersion"></span></p>
    </footer>
  </div>

  <script>
    // Load version
    fetch('version.json').then(r => r.json()).then(d => {
      document.getElementById('appVersion').textContent = 'v' + d.version;
    }).catch(() => {});

    // Generate stars
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 60; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 3) + 's';
      star.style.animationDuration = (2 + Math.random() * 2) + 's';
      const size = Math.random() > 0.85 ? 3 : (Math.random() > 0.5 ? 2 : 1);
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      starsContainer.appendChild(star);
    }

    // Parse URL parameter
    const params = new URLSearchParams(window.location.search);
    const masjidId = params.get('id');

    if (!masjidId) {
      document.getElementById('content').innerHTML = '<div class="error">❌ No masjid specified. Please select a masjid from the home page.</div>';
      throw new Error('No masjid ID provided');
    }

    let config = null;
    let csvData = [];
    let currentView = 'today';

    // Load masjid config and CSV
    async function loadData() {
      try {
        // Load config
        const configRes = await fetch(`data/mosques/${masjidId}.json`);
        if (!configRes.ok) throw new Error('Masjid not found');
        config = await configRes.json();

        // Inject dynamic PWA manifest with this masjid's start URL
        const manifest = {
          name: `Prayerly - ${config.display_name}`,
          short_name: 'Prayerly',
          start_url: `masjid.html?id=${masjidId}`,
          scope: './',
          display: 'standalone',
          orientation: 'portrait',
          background_color: '#050c18',
          theme_color: '#050c18',
          icons: [
            { src: 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' },
            { src: 'icons/icon-maskable-192.png', sizes: '192x192', type: 'image/png', purpose: 'maskable' },
            { src: 'icons/icon-maskable-512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }
          ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = URL.createObjectURL(blob);
        document.head.appendChild(manifestLink);

        // Set iOS app title to mosque name
        const appleMeta = document.createElement('meta');
        appleMeta.name = 'apple-mobile-web-app-title';
        appleMeta.content = 'Prayerly';
        document.head.appendChild(appleMeta);

        // Update title
        document.title = `${config.display_name} - Prayerly`;

        // Load CSV
        const csvRes = await fetch(`data/${config.csv}`);
        if (!csvRes.ok) throw new Error('Timetable not found');
        const csvText = await csvRes.text();

        // Parse CSV
        csvData = parseCSV(csvText);

        // Render initial view
        renderContent();
      } catch (error) {
        document.getElementById('content').innerHTML = `<div class="error">❌ ${error.message}</div>`;
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index];
        });
        rows.push(row);
      }

      return rows;
    }

    function parseDate(dateStr) {
      // Parse "18 Feb" format
      const parts = dateStr.trim().split(' ');
      const day = parseInt(parts[0]);
      const month = parts[1];
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const monthIndex = monthNames.indexOf(month);
      return new Date(2026, monthIndex, day);
    }

    function getTodayRow() {
      const today = new Date();
      for (const row of csvData) {
        const rowDate = parseDate(row['Date']);
        if (rowDate.toDateString() === today.toDateString()) {
          return row;
        }
      }
      return null;
    }

    function getTomorrowRow() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      for (const row of csvData) {
        const rowDate = parseDate(row['Date']);
        if (rowDate.toDateString() === tomorrow.toDateString()) {
          return row;
        }
      }
      return null;
    }

    function formatFullDate(dateStr, dayStr) {
      const dayMap = {
        'Mon': 'Monday', 'Tue': 'Tuesday', 'Wed': 'Wednesday',
        'Thu': 'Thursday', 'Fri': 'Friday', 'Sat': 'Saturday', 'Sun': 'Sunday'
      };
      const fullDay = dayMap[dayStr] || dayStr;
      return `${fullDay} ${dateStr} 2026`;
    }

    function renderContent() {
      if (currentView === 'today') {
        renderTodayView();
      } else {
        renderMonthlyView();
      }
    }

    let countdownInterval = null;
    let eshaRerenderId = null;

    function parseTimeToDate(timeStr, isAM) {
      const parts = timeStr.trim().split(':');
      let hours = parseInt(parts[0]);
      const minutes = parseInt(parts[1]);
      if (!isAM && hours !== 12) hours += 12;
      if (isAM && hours === 12) hours = 0;
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
    }

    function formatCountdown(prayerDate) {
      const now = new Date();
      const diffMs = prayerDate - now;
      if (diffMs <= 0) return null;
      const diffMinutes = Math.ceil(diffMs / 60000);
      const hours = Math.floor(diffMinutes / 60);
      const minutes = diffMinutes % 60;
      if (diffMinutes < 1) return 'in <1m';
      if (hours === 0) return `in ${minutes}m`;
      return `in ${hours}h ${minutes}m`;
    }

    function getNextPrayer(todayRow) {
      const prayers = [
        { name: 'Fajr', keys: ["Fajr Jama'at", "Fajr Jamaat"], isAM: true },
        { name: 'Dhuhr', keys: ["Zohar Jama'at", "Zohar Jamaat"], isAM: false, defaultTime: '1:00' },
        { name: 'Asr', keys: ["Asr Jama'at", "Asr Jamaat"], isAM: false },
        { name: 'Maghrib', keys: ["Maghrib Iftari", "Iftaar Maghrib"], isAM: false },
        { name: 'Esha', keys: ["Esha Jama'at", "Isha Jama'at", "Esha Jamaat", "Isha Jamaat"], isAM: false },
      ];

      const now = new Date();

      for (const prayer of prayers) {
        let timeStr = null;
        for (const key of prayer.keys) {
          if (todayRow[key]) { timeStr = todayRow[key]; break; }
        }
        if (!timeStr && prayer.defaultTime) timeStr = prayer.defaultTime;
        if (!timeStr) continue;

        const prayerDate = parseTimeToDate(timeStr, prayer.isAM);
        if (prayerDate > now) {
          return { name: prayer.name, date: prayerDate };
        }
      }
      return null;
    }

    function applyNextPrayerHighlight(todayRow) {
      document.querySelectorAll('.next-prayer').forEach(el => el.classList.remove('next-prayer'));
      document.querySelectorAll('.countdown').forEach(el => el.remove());

      const next = getNextPrayer(todayRow);
      if (!next) {
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        return;
      }

      const countdown = formatCountdown(next.date);

      // Highlight matching rows in both Start Times and Jama'at grids
      const grids = document.querySelectorAll('.times-grid');
      grids.forEach((grid, gridIndex) => {
        grid.querySelectorAll('.time-item').forEach(item => {
          const label = item.querySelector('.time-label');
          if (label && label.textContent.trim() === next.name) {
            item.classList.add('next-prayer');
            // Add countdown only to Jama'at section (second grid)
            if (gridIndex === 1 && countdown) {
              const span = document.createElement('span');
              span.className = 'countdown';
              span.textContent = countdown;
              label.appendChild(span);
            }
          }
        });
      });

      // Sehri countdown — today's sehri (only if not yet passed)
      const sehriTime = todayRow['Sehri Ends'] || todayRow['End of Suhoor'];
      if (sehriTime) {
        const sehriDate = parseTimeToDate(sehriTime, true);
        const sehriCountdown = formatCountdown(sehriDate);
        if (sehriCountdown) {
          document.querySelectorAll('.banner-label').forEach(label => {
            if (label.textContent.trim() === 'Sehri Ends') {
              const span = document.createElement('span');
              span.className = 'countdown';
              span.textContent = sehriCountdown;
              label.appendChild(span);
            }
          });
        }
      }

      // Tomorrow's sehri countdown — only after Esha jama'at has passed
      const eshaJamaatTime = todayRow["Esha Jama'at"] || todayRow["Isha Jama'at"] || todayRow["Esha Jamaat"] || todayRow["Isha Jamaat"];
      if (eshaJamaatTime) {
        const eshaDate = parseTimeToDate(eshaJamaatTime, false);
        if (new Date() > eshaDate) {
          const tomorrowRow = getTomorrowRow();
          if (tomorrowRow) {
            const tomorrowSehriTime = tomorrowRow['Sehri Ends'] || tomorrowRow['End of Suhoor'];
            if (tomorrowSehriTime) {
              const tomorrow = new Date();
              tomorrow.setDate(tomorrow.getDate() + 1);
              const parts = tomorrowSehriTime.trim().split(':');
              let hours = parseInt(parts[0]);
              const minutes = parseInt(parts[1]);
              if (hours === 12) hours = 0;
              const tomorrowSehriDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), hours, minutes);
              const tomorrowCountdown = formatCountdown(tomorrowSehriDate);
              if (tomorrowCountdown) {
                document.querySelectorAll('.banner-label').forEach(label => {
                  if (label.textContent.includes("Tomorrow")) {
                    const span = document.createElement('span');
                    span.className = 'countdown';
                    span.textContent = tomorrowCountdown;
                    label.appendChild(span);
                  }
                });
              }
            }
          }
        }
      }

      // Iftari countdown — only visible on banner before maghrib time
      const maghribTime = todayRow['Maghrib Iftari'] || todayRow['Iftaar Maghrib'];
      if (maghribTime) {
        const maghribDate = parseTimeToDate(maghribTime, false);
        const iftariCountdown = formatCountdown(maghribDate);
        if (iftariCountdown || (next && next.name === 'Maghrib')) {
          document.querySelectorAll('.banner-item').forEach(item => {
            const label = item.querySelector('.banner-label');
            if (label && label.textContent.includes('Maghrib')) {
              if (next && next.name === 'Maghrib') item.classList.add('next-prayer');
              if (iftariCountdown) {
                const span = document.createElement('span');
                span.className = 'countdown';
                span.textContent = iftariCountdown;
                label.appendChild(span);
              }
            }
          });
        }
      }
    }

    function renderTodayView() {
      const todayRow = getTodayRow();

      if (!todayRow) {
        document.getElementById('content').innerHTML = `
          <div class="error">
            ❌ No prayer times available for today.<br>
            <small>Ramadan 2026: 18 Feb – 19 Mar</small>
          </div>
        `;
        return;
      }

      const englishDate = formatFullDate(todayRow['Date'], todayRow['Day']);
      const hijriDate = `${todayRow['Ramadan'] || todayRow['Hijri']} Ramadan 1447`;

      const tomorrowRow = getTomorrowRow();
      const tomorrowSehri = tomorrowRow
        ? (tomorrowRow['Sehri Ends'] || tomorrowRow['End of Suhoor'])
        : null;
      const todaySehri = todayRow['Sehri Ends'] || todayRow['End of Suhoor'];
      const sehriPassed = todaySehri && parseTimeToDate(todaySehri, true) < new Date();

      let sehriBannerHtml;
      if (tomorrowSehri) {
        const frontLabel = sehriPassed ? "Tomorrow's Sehri" : 'Sehri Ends';
        const frontTime = sehriPassed ? tomorrowSehri : todaySehri;
        const backLabel = sehriPassed ? 'Sehri Ends' : "Tomorrow's Sehri";
        const backTime = sehriPassed ? todaySehri : tomorrowSehri;
        sehriBannerHtml = `<div class="flip-card" id="sehriFlip" onclick="flipSehriCard()">
            <div class="flip-card-inner">
              <div class="flip-card-front banner-item">
                <div class="flip-hint">\u21BB</div>
                <div class="banner-label">${frontLabel}</div>
                <div class="banner-time">${frontTime}</div>
              </div>
              <div class="flip-card-back banner-item">
                <div class="flip-hint">\u21BB</div>
                <div class="banner-label">${backLabel}</div>
                <div class="banner-time">${backTime}</div>
              </div>
            </div>
          </div>`;
      } else {
        sehriBannerHtml = `<div class="banner-item">
            <div class="banner-label">Sehri Ends</div>
            <div class="banner-time">${todaySehri}</div>
          </div>`;
      }

      const html = `
        <header>
          <h1>${config.display_name}</h1>
          <div class="date-line">${englishDate}</div>
          <div class="hijri-line">${hijriDate}</div>
        </header>

        <div class="view-toggle">
          <div class="toggle-container">
            <div class="toggle-slider" id="toggleSlider"></div>
            <button class="toggle-btn active" onclick="switchView('today')">Today</button>
            <button class="toggle-btn" onclick="switchView('monthly')">Month</button>
          </div>
        </div>

        <div class="times-card">
          <div class="lockscreen-section">
            <div class="section-banner">
              ${sehriBannerHtml}
              <div class="banner-item">
                <div class="banner-label">Maghrib/Iftari</div>
                <div class="banner-time">${todayRow['Maghrib Iftari'] || todayRow['Iftaar Maghrib']}</div>
              </div>
            </div>
          </div>

          <div class="gold-divider">
            <div class="line"></div>
            <div class="diamond"></div>
            <div class="line"></div>
          </div>

          <div class="lockscreen-section">
            <div class="section-title">Prayer Start Times</div>
            <div class="times-grid">
              <div class="time-item">
                <div class="time-label">Sunrise</div>
                <div class="time-value">${todayRow['Sunrise']}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Dhuhr</div>
                <div class="time-value">${todayRow['Zohr'] || todayRow['Zuhr Start']}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Asr</div>
                <div class="time-value">${todayRow['Asr'] || todayRow['Asr Start']}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Esha</div>
                <div class="time-value">${todayRow['Esha'] || todayRow['Isha Start']}</div>
              </div>
            </div>

            <div class="section-title" style="margin-top: 16px;">Jama'at Times</div>
            <div class="times-grid">
              <div class="time-item">
                <div class="time-label">Fajr</div>
                <div class="time-value">${todayRow["Fajr Jama'at"] || todayRow["Fajr Jamaat"]}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Dhuhr</div>
                <div class="time-value">${todayRow["Zohar Jama'at"] || todayRow["Zohar Jamaat"] || '1:00'}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Asr</div>
                <div class="time-value">${todayRow["Asr Jama'at"] || todayRow["Asr Jamaat"]}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Esha</div>
                <div class="time-value">${todayRow["Esha Jama'at"] || todayRow["Isha Jama'at"] || todayRow["Esha Jamaat"] || todayRow["Isha Jamaat"]}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="btn-row">
          <a href="latest/ramadan_lockscreen_${masjidId}_latest.png" class="download-btn" download onclick="if(window.goatcounter){window.goatcounter.count({path: '/download/${masjidId}', title: 'Download - ${config.display_name}', event: true});}">Download</a>
          <button class="share-btn" onclick="shareTimes()">Share</button>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Wire up swipe support on flip card
      const flipCard = document.getElementById('sehriFlip');
      if (flipCard) {
        let startX = 0;
        flipCard.addEventListener('touchstart', function(e) {
          startX = e.touches[0].clientX;
        }, { passive: true });
        flipCard.addEventListener('touchend', function(e) {
          const deltaX = e.changedTouches[0].clientX - startX;
          if (Math.abs(deltaX) > 30) {
            flipCard.classList.toggle('flipped');
          }
        }, { passive: true });
      }

      // Apply next prayer highlight and start countdown
      applyNextPrayerHighlight(todayRow);
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        const row = getTodayRow();
        if (row && currentView === 'today') {
          applyNextPrayerHighlight(row);
        }
      }, 60000);

      // Schedule a re-render after Esha so the flip card swaps to tomorrow's sehri
      if (eshaRerenderId) clearTimeout(eshaRerenderId);
      const eshaTime = todayRow["Esha Jama'at"] || todayRow["Isha Jama'at"] || todayRow["Esha Jamaat"] || todayRow["Isha Jamaat"];
      if (eshaTime) {
        const eshaDate = parseTimeToDate(eshaTime, false);
        const msUntilEsha = eshaDate - new Date();
        if (msUntilEsha > 0) {
          eshaRerenderId = setTimeout(() => {
            if (currentView === 'today') renderTodayView();
          }, msUntilEsha + 60000); // 1 min after Esha to ensure it's passed
        }
      }
    }

    function renderMonthlyView() {
      const hasZawal = csvData.length > 0 && csvData[0]['Zawal'] != null;
      const startColspan = hasZawal ? 6 : 5;

      const zawalHeader = hasZawal ? '<th>Zawal</th>' : '';

      const html = `
        <header>
          <h1>${config.display_name}</h1>
          <div class="date-line">Ramadan 2026 Timetable</div>
          <div class="hijri-line">1-30 Ramadan 1447</div>
        </header>

        <div class="view-toggle">
          <div class="toggle-container">
            <div class="toggle-slider monthly" id="toggleSlider"></div>
            <button class="toggle-btn" onclick="switchView('today')">Today</button>
            <button class="toggle-btn active" onclick="switchView('monthly')">Month</button>
          </div>
        </div>

        <div class="calendar-grid">
          <table class="calendar-table">
            <thead>
              <tr>
                <th class="section-header"></th>
                <th class="section-header"></th>
                <th class="section-header"></th>
                <th class="section-header section-divider" colspan="${startColspan}">Start Times</th>
                <th class="section-header section-divider" colspan="5">Jama'at Times</th>
              </tr>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Hijri</th>
                <th class="section-divider">Sehri</th>
                <th>Sunrise</th>
                ${zawalHeader}
                <th>Dhuhr</th>
                <th>Asr</th>
                <th>Esha</th>
                <th class="section-divider">Fajr</th>
                <th>Dhuhr</th>
                <th>Asr</th>
                <th>Maghrib</th>
                <th>Esha</th>
              </tr>
            </thead>
            <tbody>
              ${csvData.map(row => {
                const rowDate = parseDate(row['Date']);
                const today = new Date();
                const isToday = rowDate.toDateString() === today.toDateString();
                const zawalCell = hasZawal ? `<td>${row['Zawal']}</td>` : '';

                return `
                  <tr ${isToday ? 'class="today"' : ''}>
                    <td class="date-col">${row['Date']}</td>
                    <td>${row['Day']}</td>
                    <td>${row['Ramadan'] || row['Hijri']}</td>
                    <td class="section-divider">${row['Sehri Ends'] || row['End of Suhoor']}</td>
                    <td>${row['Sunrise']}</td>
                    ${zawalCell}
                    <td>${row['Zohr'] || row['Zuhr Start']}</td>
                    <td>${row['Asr'] || row['Asr Start']}</td>
                    <td>${row['Esha'] || row['Isha Start']}</td>
                    <td class="section-divider">${row["Fajr Jama'at"] || row["Fajr Jamaat"]}</td>
                    <td>${row["Zohar Jama'at"] || row["Zohar Jamaat"] || '\u2014'}</td>
                    <td>${row["Asr Jama'at"] || row["Asr Jamaat"]}</td>
                    <td>${row['Maghrib Iftari'] || row['Iftaar Maghrib']}</td>
                    <td>${row["Esha Jama'at"] || row["Isha Jama'at"] || row["Esha Jamaat"] || row["Isha Jamaat"]}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Highlight next prayer cell in today's row
      const todayRow = getTodayRow();
      if (todayRow) {
        const next = getNextPrayer(todayRow);
        if (next) {
          const dhuhrStartIdx = hasZawal ? 6 : 5;
          const jamaatIdx = hasZawal ? 9 : 8;
          const colMap = {
            'Fajr': jamaatIdx,
            'Dhuhr': dhuhrStartIdx,
            'Asr': dhuhrStartIdx + 1,
            'Maghrib': jamaatIdx + 3,
            'Esha': jamaatIdx + 4
          };
          const colIndex = colMap[next.name];
          if (colIndex !== undefined) {
            const row = document.querySelector('.calendar-table tbody tr.today');
            if (row) {
              const cell = row.children[colIndex];
              if (cell) cell.style.color = '#90c090';
            }
          }
        }
      }
    }

    function switchView(view) {
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
      if (eshaRerenderId) { clearTimeout(eshaRerenderId); eshaRerenderId = null; }
      currentView = view;
      renderContent();

      // Track view switching in GoatCounter
      if (window.goatcounter) {
        window.goatcounter.count({
          path: `/masjid/${view}`,
          title: `${config.display_name} - ${view} view`,
          event: true,
        });
      }
    }

    // Make switchView available globally
    window.switchView = switchView;

    function flipSehriCard() {
      document.getElementById('sehriFlip').classList.toggle('flipped');
    }
    window.flipSehriCard = flipSehriCard;

    async function shareTimes() {
      const shareUrl = window.location.href;
      const shareText = `Prayer times for ${config.display_name} on Prayerly\n${shareUrl}`;

      if (window.goatcounter) {
        window.goatcounter.count({
          path: `/share/${masjidId}`,
          title: `Share - ${config.display_name}`,
          event: true,
        });
      }

      if (navigator.share) {
        try {
          await navigator.share({
            title: `${config.display_name} - Prayerly`,
            text: `Prayer times for ${config.display_name} on Prayerly`,
            url: shareUrl,
          });
        } catch (err) {
          // User cancelled or share failed silently
        }
      } else if (navigator.clipboard) {
        try {
          await navigator.clipboard.writeText(shareText);
          const btn = document.querySelector('.share-btn');
          const original = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = original; }, 2000);
        } catch (err) {
          // Clipboard failed silently
        }
      }
    }
    window.shareTimes = shareTimes;

    // Load data on page load
    loadData();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // Install prompt logic
    (function() {
      // Don't show if already installed as standalone
      if (window.matchMedia('(display-mode: standalone)').matches || navigator.standalone) return;

      // Don't show if previously dismissed
      if (localStorage.getItem('installDismissed')) return;

      const banner = document.getElementById('installBanner');
      const text = document.getElementById('installText');
      const btn = document.getElementById('installBtn');
      const dismiss = document.getElementById('installDismiss');

      let deferredPrompt = null;

      // Android: capture the beforeinstallprompt event
      window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        text.innerHTML = '<strong>Add to Home Screen</strong> - Get quick access to prayer times as a standalone app.';
        btn.textContent = 'Install';
        btn.style.display = '';
        banner.classList.add('visible');

        btn.addEventListener('click', function() {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(function() {
            deferredPrompt = null;
            banner.classList.remove('visible');
          });
        });
      });

      // iOS: detect Safari on iOS (no beforeinstallprompt)
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS && !navigator.standalone) {
        text.innerHTML = 'Tap the <strong>Share</strong> button, then <strong>Add to Home Screen</strong> for quick access as a standalone app.';
        banner.classList.add('visible');
      }

      dismiss.addEventListener('click', function() {
        banner.classList.remove('visible');
        localStorage.setItem('installDismissed', '1');
      });
    })();
  </script>

  <!-- GoatCounter Analytics -->
  <script data-goatcounter="https://hasan1239.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>
