<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico">
  <meta name="theme-color" content="#050c18">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <title>Prayerly - Prayer Times</title>
  <script>
    (function() {
      function syncTheme() {
        var stored = localStorage.getItem('prayerly-theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var shouldBeLight = stored === 'light' || (!stored && !prefersDark);
        var isLight = document.documentElement.classList.contains('light-mode');
        if (shouldBeLight && !isLight) document.documentElement.classList.add('light-mode');
        else if (!shouldBeLight && isLight) document.documentElement.classList.remove('light-mode');
      }
      syncTheme();
      window.addEventListener('pageshow', function(e) { if (e.persisted) syncTheme(); });
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: linear-gradient(180deg, #050c18, #0a1628 40%, #0d1f15);
      --overlay-1: #1a4a3a;
      --overlay-2: #0d2d40;
      --overlay-3: #1a2a0d;
      --pattern-line: rgba(212,175,55,0.02);
      --text-primary: #e8e8e8;
      --text-secondary: #c0c0c0;
      --text-tertiary: #a0a0a0;
      --text-muted: #808080;
      --gold: #d4af37;
      --gold-dark: #b8941f;
      --gold-hover: #f0cd5a;
      --green: #90c090;
      --error: #e88080;
      --card-bg: rgba(255,255,255,0.05);
      --card-border: rgba(212,175,55,0.2);
      --card-hover-bg: rgba(255,255,255,0.1);
      --star-opacity: 1;
      --gold-tint-08: rgba(212,175,55,0.08);
      --gold-tint-15: rgba(212,175,55,0.15);
      --gold-tint-25: rgba(212,175,55,0.25);
      --gold-tint-30: rgba(212,175,55,0.3);
      --gold-tint-50: rgba(212,175,55,0.5);
      --gold-tint-70: rgba(212,175,55,0.7);
      --toggle-bg: rgba(30,41,59,0.5);
      --toggle-border: rgba(100,116,139,0.3);
      --toggle-inactive: #94a3b8;
      --toggle-inactive-hover: #e2e8f0;
      --divider: rgba(255,255,255,0.08);
      --divider-subtle: rgba(255,255,255,0.05);
      --divider-footer: rgba(255,255,255,0.1);
      --table-row-hover: rgba(255,255,255,0.03);
      --today-row-bg: rgba(212,175,55,0.1);
      --gold-shadow: rgba(212,175,55,0.4);
      --gold-shadow-light: rgba(212,175,55,0.2);
      --gold-shadow-glow: rgba(212,175,55,0.3);
      --section-divider-border: rgba(212,175,55,0.2);
      --section-header-border: rgba(212,175,55,0.15);
      --table-header-border: rgba(212,175,55,0.3);
      --install-border: rgba(212,175,55,0.25);
      --theme-color-value: #050c18;
    }

    :root.light-mode {
      --bg-gradient: linear-gradient(180deg, #faf6ef, #f5eed9 40%, #f0ebe0);
      --overlay-1: #d4e8d0;
      --overlay-2: #cce0ec;
      --overlay-3: #e8e0c8;
      --pattern-line: rgba(180,140,30,0.04);
      --text-primary: #1a1a2e;
      --text-secondary: #3d3d50;
      --text-tertiary: #5a5a6e;
      --text-muted: #7a7a8a;
      --gold: #b8941f;
      --gold-dark: #9a7a10;
      --gold-hover: #d4af37;
      --green: #2d7a4f;
      --error: #c0392b;
      --card-bg: rgba(255,255,255,0.75);
      --card-border: rgba(180,140,30,0.2);
      --card-hover-bg: rgba(255,255,255,0.9);
      --star-opacity: 0;
      --gold-tint-08: rgba(180,140,30,0.08);
      --gold-tint-15: rgba(180,140,30,0.15);
      --gold-tint-25: rgba(180,140,30,0.2);
      --gold-tint-30: rgba(180,140,30,0.25);
      --gold-tint-50: rgba(180,140,30,0.4);
      --gold-tint-70: rgba(180,140,30,0.5);
      --toggle-bg: rgba(200,190,170,0.4);
      --toggle-border: rgba(160,140,100,0.3);
      --toggle-inactive: #7a7a8a;
      --toggle-inactive-hover: #3d3d50;
      --divider: rgba(0,0,0,0.08);
      --divider-subtle: rgba(0,0,0,0.05);
      --divider-footer: rgba(0,0,0,0.1);
      --table-row-hover: rgba(0,0,0,0.03);
      --today-row-bg: rgba(180,140,30,0.1);
      --gold-shadow: rgba(180,140,30,0.3);
      --gold-shadow-light: rgba(180,140,30,0.15);
      --gold-shadow-glow: rgba(180,140,30,0.2);
      --section-divider-border: rgba(180,140,30,0.2);
      --section-header-border: rgba(180,140,30,0.15);
      --table-header-border: rgba(180,140,30,0.3);
      --install-border: rgba(180,140,30,0.25);
      --theme-color-value: #faf6ef;
    }

    .theme-transitioning,
    .theme-transitioning *,
    .theme-transitioning *::before,
    .theme-transitioning *::after {
      transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease, opacity 0.4s ease !important;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Lato', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 16px 16px;
      position: relative;
      overflow-x: hidden;
    }

    /* Gradient overlays */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 50% -10%, var(--overlay-1), transparent 60%),
        radial-gradient(ellipse at 100% 50%, var(--overlay-2), transparent 50%),
        radial-gradient(ellipse at 0% 80%, var(--overlay-3), transparent 50%);
      z-index: 0;
      opacity: 0.5;
    }

    /* Islamic pattern */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(60deg, transparent, transparent 28px, var(--pattern-line) 28px, var(--pattern-line) 29px),
        repeating-linear-gradient(-60deg, transparent, transparent 28px, var(--pattern-line) 28px, var(--pattern-line) 29px);
      z-index: 1;
      pointer-events: none;
    }

    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
      opacity: var(--star-opacity);
      transition: opacity 0.4s ease;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.7; }
    }

    /* Golden dust motes for light mode */
    .dust-motes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    :root.light-mode .dust-motes { opacity: 1; }

    .mote {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(180,140,30,0.4), rgba(180,140,30,0) 70%);
      animation: drift 8s ease-in-out infinite;
    }
    @keyframes drift {
      0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
      33% { transform: translateY(-12px) translateX(5px); opacity: 0.5; }
      66% { transform: translateY(-6px) translateX(-3px); opacity: 0.3; }
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    .download-btn {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border: none;
      color: #0a0a0a;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      width: 100%;
      text-align: center;
      margin-top: 6px;
      margin-bottom: 0;
    }

    .download-btn:hover {
      background: linear-gradient(135deg, var(--gold-hover), var(--gold));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--gold-shadow);
    }

    .download-btn:active {
      transform: translateY(0);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }

    .btn-row .download-btn {
      margin-top: 0;
      margin-bottom: 0;
    }

    .share-btn {
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .share-btn:hover {
      background: var(--gold-tint-15);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--gold-shadow-light);
    }

    .share-btn:active {
      transform: translateY(0);
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 18px;
    }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 6px;
      font-weight: 700;
      line-height: 1.2;
    }

    .date-line {
      font-size: 0.85rem;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }

    .hijri-line {
      font-family: 'Amiri', serif;
      font-size: 0.95rem;
      color: var(--green);
      margin-bottom: 10px;
    }

    /* View toggle */
    .view-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .toggle-container {
      position: relative;
      display: flex;
      padding: 4px;
      background: var(--toggle-bg);
      backdrop-filter: blur(8px);
      border-radius: 10px;
      border: 1px solid var(--toggle-border);
      width: 100%;
    }

    .toggle-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: calc(50% - 4px);
      height: calc(100% - 8px);
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border-radius: 8px;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 8px var(--gold-shadow-glow);
    }

    .toggle-slider.monthly {
      transform: translateX(100%);
    }

    .toggle-btn {
      position: relative;
      flex: 1;
      padding: 10px 20px;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--toggle-inactive);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.3s ease;
      z-index: 1;
      text-align: center;
    }

    .toggle-btn.active {
      color: #0a0a0a;
      font-weight: 700;
    }

    .toggle-btn:hover:not(.active) {
      color: var(--toggle-inactive-hover);
    }

    /* Content sections */
    .view-container {
      display: none;
    }

    .view-container.active {
      display: block;
    }

    /* Today's times table */
    .times-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 12px 16px 6px 16px;
      margin-bottom: 20px;
    }

    .section-title {
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      color: var(--gold);
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
    }

    .times-table {
      width: 100%;
    }

    .time-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--divider);
    }

    .time-row:last-child {
      border-bottom: none;
    }

    .time-label {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .time-value {
      font-family: 'Cinzel', serif;
      font-size: 1.15rem;
      color: var(--gold);
      font-weight: 600;
    }

    /* Divider between sections */
    .gold-divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 16px 0;
    }

    .gold-divider .line {
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }

    .gold-divider .diamond {
      width: 8px;
      height: 8px;
      background: var(--gold);
      transform: rotate(45deg);
      margin: 0 12px;
    }

    /* Lockscreen-style layout */
    .lockscreen-section {
      margin: 12px 0;
    }

    .section-banner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
      align-items: stretch;
    }

    .banner-item {
      background: linear-gradient(135deg, var(--gold-tint-15), var(--gold-tint-08));
      border: 1px solid var(--gold-tint-30);
      border-radius: 10px;
      padding: 12px 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .banner-label {
      font-family: 'Lato', sans-serif;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-bottom: 6px;
      font-weight: 400;
    }

    .banner-time {
      font-family: 'Cinzel', serif;
      font-size: 1.35rem;
      color: var(--gold);
      font-weight: 700;
    }

    /* Flip card for sehri banner */
    .flip-card {
      perspective: 600px;
      cursor: pointer;
      display: flex;
    }

    .flip-card-inner {
      position: relative;
      transition: transform 0.5s ease;
      transform-style: preserve-3d;
      flex: 1;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      position: relative;
      min-height: 100%;
    }

    .flip-card-back {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: rotateY(180deg);
    }

    .flip-hint {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 0.65rem;
      color: var(--gold-tint-50);
      line-height: 1;
    }

    .times-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .time-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--divider);
    }

    .time-item:last-child {
      border-bottom: none;
    }

    .time-item .time-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .time-item .time-value {
      font-family: 'Cinzel', serif;
      font-size: 1.05rem;
      color: var(--gold);
      font-weight: 600;
    }

    /* Next prayer highlight */
    .time-item.next-prayer {
      background: var(--gold-tint-08);
      border-left: 3px solid var(--gold);
      margin: 0 -12px;
      padding-left: 12px;
      padding-right: 12px;
      border-radius: 6px;
    }

    .banner-item.next-prayer {
      background: linear-gradient(135deg, var(--gold-tint-25), var(--gold-tint-15));
      border-color: var(--gold-tint-50);
      box-sizing: border-box;
      min-width: 0;
    }

    .countdown {
      font-family: 'Lato', sans-serif;
      font-size: 0.7rem;
      color: var(--green);
      font-weight: 400;
      margin-left: 6px;
    }

    @media (max-width: 767px) {
      .banner-label .countdown {
        display: block;
        margin-left: 0;
      }
      .banner-label {
        min-height: 2.4em;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
    }

    /* Monthly calendar view */
    .calendar-grid {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 20px;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--gold-tint-30) transparent;
    }
    .calendar-grid::-webkit-scrollbar {
      height: 6px;
    }
    .calendar-grid::-webkit-scrollbar-track {
      background: transparent;
    }
    .calendar-grid::-webkit-scrollbar-thumb {
      background: var(--gold-tint-30);
      border-radius: 3px;
    }
    .calendar-grid::-webkit-scrollbar-thumb:hover {
      background: var(--gold-tint-50);
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .calendar-table thead th {
      font-family: 'Cinzel', serif;
      color: var(--gold);
      font-weight: 600;
      padding: 10px 8px;
      text-align: center;
      border-bottom: 2px solid var(--table-header-border);
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .calendar-table tbody td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--divider-subtle);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .calendar-table tbody tr:last-child td {
      border-bottom: none;
    }

    .calendar-table tbody tr:hover {
      background: var(--table-row-hover);
    }

    .calendar-table tbody tr.today {
      background: var(--today-row-bg);
    }

    .calendar-table tbody tr.today td {
      color: var(--gold);
      font-weight: 600;
    }

    .calendar-table .section-header {
      font-size: 0.7rem;
      color: var(--gold-tint-70);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--section-header-border);
      padding: 6px 8px;
    }

    .calendar-table .section-divider {
      border-left: 1px solid var(--section-divider-border);
    }

    .date-col {
      color: var(--text-tertiary);
      font-weight: 500;
    }

    .ai-disclaimer {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin: 12px 0 0;
      padding: 0 8px;
    }

    .next-prayer-cell {
      color: var(--green) !important;
    }

    /* Install banner */
    .install-banner {
      background: var(--gold-tint-08);
      border: 1px solid var(--install-border);
      border-radius: 10px;
      padding: 14px 16px;
      margin-top: 14px;
      display: none;
      position: relative;
    }

    .install-banner.has-button {
      padding-bottom: 48px;
    }

    .install-banner.visible {
      display: block;
    }

    .install-banner-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      padding-right: 24px;
    }

    .install-banner-text strong {
      color: var(--gold);
    }

    .install-btn {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border: none;
      color: #0a0a0a;
      padding: 8px 18px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      position: absolute;
      bottom: 14px;
      right: 16px;
    }

    .install-btn:hover {
      background: linear-gradient(135deg, var(--gold-hover), var(--gold));
    }

    .install-dismiss {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      position: absolute;
      top: 12px;
      right: 14px;
    }

    .install-dismiss:hover {
      color: var(--text-secondary);
    }

    /* Loading & error states */
    .loading, .error {
      text-align: center;
      padding: 60px 20px;
      font-size: 1.1rem;
      color: var(--text-tertiary);
    }

    .error {
      color: var(--error);
    }

    /* Stale timetable notice */
    .stale-notice {
      text-align: center;
      padding: 40px 20px;
    }
    .stale-notice h2 {
      color: var(--gold);
      font-size: 1.3rem;
      margin-bottom: 12px;
    }
    .stale-notice p {
      color: var(--text-tertiary);
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    .upload-btn {
      display: inline-block;
      padding: 10px 24px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      color: var(--text-muted);
      font-size: 0.9rem;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .upload-btn .coming-soon-label {
      font-size: 0.75rem;
      display: block;
      margin-top: 4px;
      color: var(--coming-soon-text);
    }

    /* Update times nudge (shown when timetable is nearing end) */
    .update-nudge {
      text-align: center;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--divider-footer);
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Theme toggle button */
    .theme-toggle {
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + 16px);
      right: 16px;
      z-index: 100;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      padding: 0;
    }

    .theme-toggle:hover {
      background: var(--card-hover-bg);
      border-color: var(--gold-tint-50);
    }

    .theme-toggle svg {
      width: 16px;
      height: 16px;
    }

    .theme-icon--sun { display: block; color: var(--gold); }
    .theme-icon--moon { display: none; color: var(--gold); }
    :root.light-mode .theme-icon--sun { display: none; }
    :root.light-mode .theme-icon--moon { display: block; }

    /* Desktop styles */
    @media (min-width: 768px) {
      body {
        padding: 40px 30px;
      }

      h1 {
        font-size: 2.5rem;
      }

      .date-line {
        font-size: 1.05rem;
      }

      .hijri-line {
        font-size: 1.15rem;
      }

      .toggle-btn {
        padding: 10px 24px;
        font-size: 0.9rem;
      }

      .times-card {
        padding: 35px 40px;
      }

      .time-row {
        padding: 15px 0;
      }

      .time-label {
        font-size: 1.1rem;
      }

      .time-value {
        font-size: 1.3rem;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .banner-item {
        padding: 22px 18px;
      }

      .banner-label {
        font-size: 0.95rem;
        margin-bottom: 10px;
      }

      .banner-time {
        font-size: 1.85rem;
      }

      .flip-hint {
        font-size: 0.75rem;
        top: 8px;
        right: 10px;
      }

      .time-item {
        padding: 16px 0;
      }

      .time-item .time-label {
        font-size: 1.1rem;
      }

      .time-item .time-value {
        font-size: 1.3rem;
      }

      .countdown {
        font-size: 0.8rem;
      }

      .btn-row {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 15px;
      }

      .download-btn {
        width: auto;
      }

      .calendar-table {
        font-size: 0.9rem;
      }

      .calendar-table thead th {
        font-size: 0.85rem;
        padding: 12px 10px;
      }

      .calendar-table tbody td {
        padding: 12px 10px;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle light/dark mode">
    <svg class="theme-icon--sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <svg class="theme-icon--moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
  </button>

  <div class="stars" id="stars"></div>
  <!-- Golden dust motes (light mode) -->
  <div class="dust-motes" id="dustMotes"></div>

  <div class="container">
    <div id="content">
      <div class="loading">Loading prayer times...</div>
    </div>

    <div class="install-banner" id="installBanner">
      <div class="install-banner-text" id="installText"></div>
      <button class="install-btn" id="installBtn" style="display:none;"></button>
      <button class="install-dismiss" id="installDismiss" title="Dismiss">&times;</button>
    </div>

    <footer>
      <p>Updates daily at 4:30am GMT · © Prayerly <span id="appVersion"></span></p>
    </footer>
  </div>

  <script>
    // Load version
    fetch('version.json').then(r => r.json()).then(d => {
      document.getElementById('appVersion').textContent = 'v' + d.version;
    }).catch(() => {});

    // Generate stars
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 60; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 3) + 's';
      star.style.animationDuration = (2 + Math.random() * 2) + 's';
      const size = Math.random() > 0.85 ? 3 : (Math.random() > 0.5 ? 2 : 1);
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      starsContainer.appendChild(star);
    }

    // Generate golden dust motes (light mode)
    const motesContainer = document.getElementById('dustMotes');
    for (let i = 0; i < 60; i++) {
      const mote = document.createElement('div');
      mote.className = 'mote';
      mote.style.left = Math.random() * 100 + '%';
      mote.style.top = Math.random() * 100 + '%';
      mote.style.animationDelay = (Math.random() * 8) + 's';
      mote.style.animationDuration = (6 + Math.random() * 6) + 's';
      const size = 3 + Math.random() * 5;
      mote.style.width = size + 'px';
      mote.style.height = size + 'px';
      motesContainer.appendChild(mote);
    }

    // Parse URL parameter
    const params = new URLSearchParams(window.location.search);
    const masjidId = params.get('id');

    if (!masjidId) {
      document.getElementById('content').innerHTML = '<div class="error">❌ No masjid specified. Please select a masjid from the home page.</div>';
      throw new Error('No masjid ID provided');
    }

    let config = null;
    let csvData = [];
    let currentView = 'today';

    // Load masjid config and CSV
    async function loadData() {
      try {
        // Load config
        const configRes = await fetch(`data/mosques/${masjidId}.json`);
        if (!configRes.ok) throw new Error('Masjid not found');
        config = await configRes.json();

        // Inject dynamic PWA manifest with this masjid's start URL
        const manifest = {
          name: `Prayerly - ${config.display_name}`,
          short_name: 'Prayerly',
          start_url: `masjid.html?id=${masjidId}`,
          scope: './',
          display: 'standalone',
          orientation: 'portrait',
          background_color: document.documentElement.classList.contains('light-mode') ? '#faf6ef' : '#050c18',
          theme_color: document.documentElement.classList.contains('light-mode') ? '#faf6ef' : '#050c18',
          icons: [
            { src: 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' },
            { src: 'icons/icon-maskable-192.png', sizes: '192x192', type: 'image/png', purpose: 'maskable' },
            { src: 'icons/icon-maskable-512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }
          ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = URL.createObjectURL(blob);
        document.head.appendChild(manifestLink);

        // Set iOS app title to mosque name
        const appleMeta = document.createElement('meta');
        appleMeta.name = 'apple-mobile-web-app-title';
        appleMeta.content = 'Prayerly';
        document.head.appendChild(appleMeta);

        // Update title
        document.title = `${config.display_name} - Prayerly`;

        // Load CSV
        const csvRes = await fetch(`data/${config.csv}`);
        if (!csvRes.ok) throw new Error('Timetable not found');
        const csvText = await csvRes.text();

        // Parse CSV
        csvData = parseCSV(csvText);

        // Render initial view
        renderContent();
      } catch (error) {
        document.getElementById('content').innerHTML = `<div class="error">❌ ${error.message}</div>`;
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index];
        });
        rows.push(row);
      }

      return rows;
    }

    function parseDate(dateStr) {
      // Parse "18 Feb" format
      const parts = dateStr.trim().split(' ');
      const day = parseInt(parts[0]);
      const month = parts[1];
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const monthIndex = monthNames.indexOf(month);
      return new Date(2026, monthIndex, day);
    }

    function getTodayRow() {
      const today = new Date();
      for (const row of csvData) {
        const rowDate = parseDate(row['Date']);
        if (rowDate.toDateString() === today.toDateString()) {
          return row;
        }
      }
      return null;
    }

    function getTomorrowRow() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      for (const row of csvData) {
        const rowDate = parseDate(row['Date']);
        if (rowDate.toDateString() === tomorrow.toDateString()) {
          return row;
        }
      }
      return null;
    }

    function formatFullDate(dateStr, dayStr) {
      const dayMap = {
        'Mon': 'Monday', 'Tue': 'Tuesday', 'Wed': 'Wednesday',
        'Thu': 'Thursday', 'Fri': 'Friday', 'Sat': 'Saturday', 'Sun': 'Sunday'
      };
      const fullDay = dayMap[dayStr] || dayStr;
      return `${fullDay} ${dateStr} 2026`;
    }

    function renderContent() {
      if (currentView === 'today') {
        renderTodayView();
      } else {
        renderMonthlyView();
      }
    }

    let countdownInterval = null;
    let eshaRerenderId = null;

    function parseTimeToDate(timeStr, isAM) {
      const parts = timeStr.trim().split(':');
      let hours = parseInt(parts[0]);
      const minutes = parseInt(parts[1]);
      if (!isAM && hours !== 12) hours += 12;
      if (isAM && hours === 12) hours = 0;
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
    }

    function formatCountdown(prayerDate) {
      const now = new Date();
      const diffMs = prayerDate - now;
      if (diffMs <= 0) return null;
      const diffMinutes = Math.ceil(diffMs / 60000);
      const hours = Math.floor(diffMinutes / 60);
      const minutes = diffMinutes % 60;
      if (diffMinutes < 1) return 'in <1m';
      if (hours === 0) return `in ${minutes}m`;
      return `in ${hours}h ${minutes}m`;
    }

    function getNextPrayer(todayRow) {
      const prayers = [
        { name: 'Fajr', keys: ["Fajr Jama'at"], isAM: true },
        { name: 'Dhuhr', keys: ["Zohar Jama'at"], isAM: false, defaultTime: '1:00' },
        { name: 'Asr', keys: ["Asr Jama'at"], isAM: false },
        { name: 'Maghrib', keys: ["Maghrib Iftari"], isAM: false },
        { name: 'Esha', keys: ["Esha Jama'at"], isAM: false },
      ];

      const now = new Date();

      for (const prayer of prayers) {
        let timeStr = null;
        for (const key of prayer.keys) {
          if (todayRow[key]) { timeStr = todayRow[key]; break; }
        }
        if (!timeStr && prayer.defaultTime) timeStr = prayer.defaultTime;
        if (!timeStr) continue;

        const prayerDate = parseTimeToDate(timeStr, prayer.isAM);
        if (prayerDate > now) {
          return { name: prayer.name, date: prayerDate };
        }
      }
      return null;
    }

    function applyNextPrayerHighlight(todayRow) {
      document.querySelectorAll('.next-prayer').forEach(el => el.classList.remove('next-prayer'));
      document.querySelectorAll('.countdown').forEach(el => el.remove());

      const next = getNextPrayer(todayRow);
      if (!next) {
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        return;
      }

      const countdown = formatCountdown(next.date);

      // Find the next upcoming start time independently
      const startTimes = [
        { name: 'Sunrise', keys: ['Sunrise'], isAM: true },
        { name: 'Dhuhr', keys: ['Zohr'], isAM: false },
        { name: 'Asr', keys: ['Asr'], isAM: false },
        { name: 'Esha', keys: ['Esha'], isAM: false },
      ];
      let nextStart = null;
      for (const st of startTimes) {
        let timeStr = null;
        for (const key of st.keys) {
          if (todayRow[key]) { timeStr = todayRow[key]; break; }
        }
        if (!timeStr) continue;
        const startDate = parseTimeToDate(timeStr, st.isAM);
        if (startDate > new Date()) {
          nextStart = { name: st.name, date: startDate };
          break;
        }
      }

      // Highlight matching rows in both Start Times and Jama'at grids
      const grids = document.querySelectorAll('.times-grid');
      grids.forEach((grid, gridIndex) => {
        grid.querySelectorAll('.time-item').forEach(item => {
          const label = item.querySelector('.time-label');
          const labelText = label && label.textContent.trim();
          if (gridIndex === 0 && nextStart && labelText === nextStart.name) {
            // Start Times grid — highlight and countdown for next start time
            item.classList.add('next-prayer');
            const startCountdown = formatCountdown(nextStart.date);
            if (startCountdown) {
              const span = document.createElement('span');
              span.className = 'countdown';
              span.textContent = startCountdown;
              label.appendChild(span);
            }
          } else if (gridIndex === 1 && labelText === next.name) {
            // Jama'at grid — highlight and countdown for next jama'at
            item.classList.add('next-prayer');
            if (countdown) {
              const span = document.createElement('span');
              span.className = 'countdown';
              span.textContent = countdown;
              label.appendChild(span);
            }
          }
        });
      });

      // Sehri countdown — today's sehri (only if not yet passed)
      const sehriTime = todayRow['Sehri Ends'];
      if (sehriTime) {
        const sehriDate = parseTimeToDate(sehriTime, true);
        const sehriCountdown = formatCountdown(sehriDate);
        if (sehriCountdown) {
          document.querySelectorAll('.banner-label').forEach(label => {
            if (label.textContent.trim() === 'Sehri Ends') {
              const span = document.createElement('span');
              span.className = 'countdown';
              span.textContent = sehriCountdown;
              label.appendChild(span);
            }
          });
        }
      }

      // Tomorrow's sehri countdown — only after Esha jama'at has passed
      const eshaJamaatTime = todayRow["Esha Jama'at"];
      if (eshaJamaatTime) {
        const eshaDate = parseTimeToDate(eshaJamaatTime, false);
        if (new Date() > eshaDate) {
          const tomorrowRow = getTomorrowRow();
          if (tomorrowRow) {
            const tomorrowSehriTime = tomorrowRow['Sehri Ends'];
            if (tomorrowSehriTime) {
              const tomorrow = new Date();
              tomorrow.setDate(tomorrow.getDate() + 1);
              const parts = tomorrowSehriTime.trim().split(':');
              let hours = parseInt(parts[0]);
              const minutes = parseInt(parts[1]);
              if (hours === 12) hours = 0;
              const tomorrowSehriDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), hours, minutes);
              const tomorrowCountdown = formatCountdown(tomorrowSehriDate);
              if (tomorrowCountdown) {
                document.querySelectorAll('.banner-label').forEach(label => {
                  if (label.textContent.includes("Tomorrow")) {
                    const span = document.createElement('span');
                    span.className = 'countdown';
                    span.textContent = tomorrowCountdown;
                    label.appendChild(span);
                  }
                });
              }
            }
          }
        }
      }

      // Iftari countdown — only visible on banner before maghrib time
      const maghribTime = todayRow['Maghrib Iftari'];
      if (maghribTime) {
        const maghribDate = parseTimeToDate(maghribTime, false);
        const iftariCountdown = formatCountdown(maghribDate);
        if (iftariCountdown || (next && next.name === 'Maghrib')) {
          document.querySelectorAll('.banner-item').forEach(item => {
            const label = item.querySelector('.banner-label');
            if (label && label.textContent.includes('Maghrib')) {
              if (next && next.name === 'Maghrib') item.classList.add('next-prayer');
              if (iftariCountdown) {
                const span = document.createElement('span');
                span.className = 'countdown';
                span.textContent = iftariCountdown;
                label.appendChild(span);
              }
            }
          });
        }
      }
    }

    function renderTodayView() {
      const todayRow = getTodayRow();

      if (!todayRow) {
        // Check if timetable is stale (last date in the past)
        const lastRow = csvData[csvData.length - 1];
        const lastDate = lastRow ? parseDate(lastRow['Date']) : null;
        const isStale = lastDate && lastDate < new Date();
        const currentMonth = new Date().toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

        if (isStale) {
          document.getElementById('content').innerHTML = `
            <header>
              <h1>${config.display_name}</h1>
            </header>
            <div class="view-toggle">
              <div class="toggle-container">
                <div class="toggle-slider" id="toggleSlider"></div>
                <button class="toggle-btn active" onclick="switchView('today')">Today</button>
                <button class="toggle-btn" onclick="switchView('monthly')">Month</button>
              </div>
            </div>
            <div class="stale-notice">
              <h2>Times for ${currentMonth} are not yet available</h2>
              <p>The current timetable has ended. New times will be added soon.</p>
              <div class="upload-btn">
                Upload new timetable
                <span class="coming-soon-label">Coming soon</span>
              </div>
            </div>
          `;
        } else {
          document.getElementById('content').innerHTML = `
            <div class="error">
              No prayer times available for today.<br>
              <small>Check back when the timetable period begins.</small>
            </div>
          `;
        }
        return;
      }

      const englishDate = formatFullDate(todayRow['Date'], todayRow['Day']);
      const hijriDate = `${todayRow['Islamic Day'] || todayRow['Ramadan'] || todayRow['Hijri']} Ramadan 1447`;

      const tomorrowRow = getTomorrowRow();
      const tomorrowSehri = tomorrowRow ? tomorrowRow['Sehri Ends'] : null;
      const todaySehri = todayRow['Sehri Ends'];
      const sehriPassed = todaySehri && parseTimeToDate(todaySehri, true) < new Date();

      let sehriBannerHtml;
      if (tomorrowSehri) {
        const frontLabel = sehriPassed ? "Tomorrow's Sehri" : 'Sehri Ends';
        const frontTime = sehriPassed ? tomorrowSehri : todaySehri;
        const backLabel = sehriPassed ? 'Sehri Ends' : "Tomorrow's Sehri";
        const backTime = sehriPassed ? todaySehri : tomorrowSehri;
        sehriBannerHtml = `<div class="flip-card" id="sehriFlip" onclick="flipSehriCard()">
            <div class="flip-card-inner">
              <div class="flip-card-front banner-item">
                <div class="flip-hint">\u21BB</div>
                <div class="banner-label">${frontLabel}</div>
                <div class="banner-time">${frontTime}</div>
              </div>
              <div class="flip-card-back banner-item">
                <div class="flip-hint">\u21BB</div>
                <div class="banner-label">${backLabel}</div>
                <div class="banner-time">${backTime}</div>
              </div>
            </div>
          </div>`;
      } else {
        sehriBannerHtml = `<div class="banner-item">
            <div class="banner-label">Sehri Ends</div>
            <div class="banner-time">${todaySehri}</div>
          </div>`;
      }

      const html = `
        <header>
          <h1>${config.display_name}</h1>
          <div class="date-line">${englishDate}</div>
          <div class="hijri-line">${hijriDate}</div>
        </header>

        <div class="view-toggle">
          <div class="toggle-container">
            <div class="toggle-slider" id="toggleSlider"></div>
            <button class="toggle-btn active" onclick="switchView('today')">Today</button>
            <button class="toggle-btn" onclick="switchView('monthly')">Month</button>
          </div>
        </div>

        <div class="times-card">
          <div class="lockscreen-section">
            <div class="section-banner">
              ${sehriBannerHtml}
              <div class="banner-item">
                <div class="banner-label">Maghrib/Iftari</div>
                <div class="banner-time">${todayRow['Maghrib Iftari']}</div>
              </div>
            </div>
          </div>

          <div class="gold-divider">
            <div class="line"></div>
            <div class="diamond"></div>
            <div class="line"></div>
          </div>

          <div class="lockscreen-section">
            <div class="section-title">Start Times</div>
            <div class="times-grid">
              <div class="time-item">
                <div class="time-label">Sunrise</div>
                <div class="time-value">${todayRow['Sunrise']}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Dhuhr</div>
                <div class="time-value">${todayRow['Zohr']}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Asr</div>
                <div class="time-value">${todayRow['Asr']}</div>
              </div>
              ${todayRow['Esha'] ? `<div class="time-item">
                <div class="time-label">Esha</div>
                <div class="time-value">${todayRow['Esha']}</div>
              </div>` : ''}
            </div>

            <div class="section-title" style="margin-top: 16px;">Jama'at Times</div>
            <div class="times-grid">
              <div class="time-item">
                <div class="time-label">Fajr</div>
                <div class="time-value">${todayRow["Fajr Jama'at"]}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Dhuhr</div>
                <div class="time-value">${todayRow["Zohar Jama'at"] || '1:00'}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Asr</div>
                <div class="time-value">${todayRow["Asr Jama'at"]}</div>
              </div>
              <div class="time-item">
                <div class="time-label">Esha</div>
                <div class="time-value">${todayRow["Esha Jama'at"]}</div>
              </div>
            </div>
          </div>
        </div>

        ${(() => {
          // Show update nudge if 5 or fewer days remaining in timetable
          const todayIdx = csvData.findIndex(r => parseDate(r['Date']).toDateString() === new Date().toDateString());
          const remaining = todayIdx >= 0 ? csvData.length - 1 - todayIdx : -1;
          if (remaining >= 0 && remaining <= 5) {
            return `<div class="update-nudge">
              <div class="upload-btn">
                Update times
                <span class="coming-soon-label">Coming soon</span>
              </div>
            </div>`;
          }
          return '';
        })()}

        <div class="btn-row">
          <a href="latest/ramadan_lockscreen_${masjidId}_latest.png" class="download-btn" download onclick="if(window.goatcounter){window.goatcounter.count({path: '/download/${masjidId}', title: 'Download - ${config.display_name}', event: true});}">Download</a>
          <button class="share-btn" onclick="shareTimes()">Share</button>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Wire up swipe support on flip card
      const flipCard = document.getElementById('sehriFlip');
      if (flipCard) {
        let startX = 0;
        flipCard.addEventListener('touchstart', function(e) {
          startX = e.touches[0].clientX;
        }, { passive: true });
        flipCard.addEventListener('touchend', function(e) {
          const deltaX = e.changedTouches[0].clientX - startX;
          if (Math.abs(deltaX) > 30) {
            flipCard.classList.toggle('flipped');
          }
        }, { passive: true });
      }

      // Update download link for current theme
      if (window.updateDownloadLink) window.updateDownloadLink();

      // Apply next prayer highlight and start countdown
      applyNextPrayerHighlight(todayRow);
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        const row = getTodayRow();
        if (row && currentView === 'today') {
          applyNextPrayerHighlight(row);
        }
      }, 60000);

      // Schedule a re-render after Esha so the flip card swaps to tomorrow's sehri
      if (eshaRerenderId) clearTimeout(eshaRerenderId);
      const eshaTime = todayRow["Esha Jama'at"];
      if (eshaTime) {
        const eshaDate = parseTimeToDate(eshaTime, false);
        const msUntilEsha = eshaDate - new Date();
        if (msUntilEsha > 0) {
          eshaRerenderId = setTimeout(() => {
            if (currentView === 'today') renderTodayView();
          }, msUntilEsha + 60000); // 1 min after Esha to ensure it's passed
        }
      }
    }

    function renderMonthlyView() {
      const hasZawal = csvData.length > 0 && csvData[0]['Zawal'] != null;
      const hasEshaStart = csvData.some(row => row['Esha']);
      const startColspan = (hasZawal ? 1 : 0) + (hasEshaStart ? 5 : 4);

      const zawalHeader = hasZawal ? '<th>Zawal</th>' : '';

      const html = `
        <header>
          <h1>${config.display_name}</h1>
          <div class="date-line">Ramadan 2026 Timetable</div>
          <div class="hijri-line">1-30 Ramadan 1447</div>
        </header>

        <div class="view-toggle">
          <div class="toggle-container">
            <div class="toggle-slider monthly" id="toggleSlider"></div>
            <button class="toggle-btn" onclick="switchView('today')">Today</button>
            <button class="toggle-btn active" onclick="switchView('monthly')">Month</button>
          </div>
        </div>

        <div class="calendar-grid">
          <table class="calendar-table">
            <thead>
              <tr>
                <th class="section-header"></th>
                <th class="section-header"></th>
                <th class="section-header"></th>
                <th class="section-header section-divider" colspan="${startColspan}">Start Times</th>
                <th class="section-header section-divider" colspan="5">Jama'at Times</th>
              </tr>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Hijri</th>
                <th class="section-divider">Sehri</th>
                <th>Sunrise</th>
                ${zawalHeader}
                <th>Dhuhr</th>
                <th>Asr</th>
                ${hasEshaStart ? '<th>Esha</th>' : ''}
                <th class="section-divider">Fajr</th>
                <th>Dhuhr</th>
                <th>Asr</th>
                <th>Maghrib</th>
                <th>Esha</th>
              </tr>
            </thead>
            <tbody>
              ${csvData.map(row => {
                const rowDate = parseDate(row['Date']);
                const today = new Date();
                const isToday = rowDate.toDateString() === today.toDateString();
                const zawalCell = hasZawal ? `<td>${row['Zawal']}</td>` : '';

                return `
                  <tr ${isToday ? 'class="today"' : ''}>
                    <td class="date-col">${row['Date']}</td>
                    <td>${row['Day']}</td>
                    <td>${row['Islamic Day'] || row['Ramadan'] || row['Hijri']}</td>
                    <td class="section-divider">${row['Sehri Ends']}</td>
                    <td>${row['Sunrise']}</td>
                    ${zawalCell}
                    <td>${row['Zohr']}</td>
                    <td>${row['Asr']}</td>
                    ${hasEshaStart ? `<td>${row['Esha']}</td>` : ''}
                    <td class="section-divider">${row["Fajr Jama'at"]}</td>
                    <td>${row["Zohar Jama'at"] || '\u2014'}</td>
                    <td>${row["Asr Jama'at"]}</td>
                    <td>${row['Maghrib Iftari']}</td>
                    <td>${row["Esha Jama'at"]}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <p class="ai-disclaimer">AI can make mistakes.</p>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Highlight next prayer cell in today's row
      const todayRow = getTodayRow();
      if (todayRow) {
        const next = getNextPrayer(todayRow);
        if (next) {
          const dhuhrStartIdx = hasZawal ? 6 : 5;
          const eshaOffset = hasEshaStart ? 1 : 0;
          const jamaatIdx = dhuhrStartIdx + 2 + eshaOffset;
          const colMap = {
            'Fajr': jamaatIdx,
            'Dhuhr': dhuhrStartIdx,
            'Asr': dhuhrStartIdx + 1,
            'Maghrib': jamaatIdx + 3,
            'Esha': jamaatIdx + 4
          };
          const colIndex = colMap[next.name];
          if (colIndex !== undefined) {
            const row = document.querySelector('.calendar-table tbody tr.today');
            if (row) {
              const cell = row.children[colIndex];
              if (cell) cell.classList.add('next-prayer-cell');
            }
          }
        }
      }
    }

    function switchView(view) {
      if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
      if (eshaRerenderId) { clearTimeout(eshaRerenderId); eshaRerenderId = null; }
      currentView = view;
      renderContent();

      // Track view switching in GoatCounter
      if (window.goatcounter) {
        window.goatcounter.count({
          path: `/masjid/${view}`,
          title: `${config.display_name} - ${view} view`,
          event: true,
        });
      }
    }

    // Make switchView available globally
    window.switchView = switchView;

    function flipSehriCard() {
      document.getElementById('sehriFlip').classList.toggle('flipped');
    }
    window.flipSehriCard = flipSehriCard;

    async function shareTimes() {
      const shareUrl = window.location.href;
      const shareText = `Prayer times for ${config.display_name} on Prayerly\n${shareUrl}`;

      if (window.goatcounter) {
        window.goatcounter.count({
          path: `/share/${masjidId}`,
          title: `Share - ${config.display_name}`,
          event: true,
        });
      }

      if (navigator.share) {
        try {
          await navigator.share({
            title: `${config.display_name} - Prayerly`,
            text: `Prayer times for ${config.display_name} on Prayerly`,
            url: shareUrl,
          });
        } catch (err) {
          // User cancelled or share failed silently
        }
      } else if (navigator.clipboard) {
        try {
          await navigator.clipboard.writeText(shareText);
          const btn = document.querySelector('.share-btn');
          const original = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = original; }, 2000);
        } catch (err) {
          // Clipboard failed silently
        }
      }
    }
    window.shareTimes = shareTimes;

    // Load data on page load
    loadData();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // Install prompt logic
    (function() {
      // Don't show if already installed as standalone
      if (window.matchMedia('(display-mode: standalone)').matches || navigator.standalone) return;

      // Don't show if previously dismissed
      if (localStorage.getItem('installDismissed')) return;

      const banner = document.getElementById('installBanner');
      const text = document.getElementById('installText');
      const btn = document.getElementById('installBtn');
      const dismiss = document.getElementById('installDismiss');

      let deferredPrompt = null;

      // Android: capture the beforeinstallprompt event
      window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        text.innerHTML = '<strong>Add to Home Screen</strong> - Get quick access to prayer times as a standalone app.';
        btn.textContent = 'Install';
        btn.style.display = '';
        banner.classList.add('visible', 'has-button');

        btn.addEventListener('click', function() {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(function() {
            deferredPrompt = null;
            banner.classList.remove('visible');
          });
        });
      });

      // iOS: detect Safari on iOS (no beforeinstallprompt)
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      var isSafari = isIOS && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(navigator.userAgent);
      if (isIOS && !navigator.standalone) {
        if (isSafari) {
          text.innerHTML = 'Tap the <strong>Share icon</strong> (<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>) in Safari\'s toolbar, then <strong>Add to Home Screen</strong> for quick access as a standalone app.';
        } else {
          text.innerHTML = 'Tap the <strong>menu icon</strong> (&#8942;) in your browser\'s toolbar, then <strong>Add to Home Screen</strong> for quick access as a standalone app.';
        }
        banner.classList.add('visible');
      }

      dismiss.addEventListener('click', function() {
        banner.classList.remove('visible');
        localStorage.setItem('installDismissed', '1');
      });
    })();
  </script>

  <script>
    (function() {
      var toggle = document.getElementById('themeToggle');
      var root = document.documentElement;
      var meta = document.querySelector('meta[name="theme-color"]');

      function updateThemeColor() {
        var isLight = root.classList.contains('light-mode');
        if (meta) meta.content = isLight ? '#faf6ef' : '#050c18';
      }

      function updateDownloadLink() {
        var downloadLink = document.querySelector('.download-btn');
        if (!downloadLink) return;
        var id = new URLSearchParams(window.location.search).get('id');
        var darkUrl = 'latest/ramadan_lockscreen_' + id + '_latest.png';
        if (!root.classList.contains('light-mode')) {
          downloadLink.href = darkUrl;
          return;
        }
        var lightUrl = 'latest/ramadan_lockscreen_' + id + '_light_latest.png';
        fetch(lightUrl, { method: 'HEAD' }).then(function(res) {
          downloadLink.href = res.ok ? lightUrl : darkUrl;
        }).catch(function() {
          downloadLink.href = darkUrl;
        });
      }

      // Expose for use after dynamic content renders
      window.updateDownloadLink = updateDownloadLink;

      // Set initial download link based on current theme
      updateDownloadLink();

      toggle.addEventListener('click', function() {
        // Crossfade overlay: capture current bg gradient, fade it out over the new theme
        var overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;inset:0;z-index:3;pointer-events:none;transition:opacity 0.4s ease;';
        overlay.style.backgroundImage = getComputedStyle(document.body).backgroundImage;
        document.body.appendChild(overlay);

        root.classList.add('theme-transitioning');
        root.classList.toggle('light-mode');
        var isLight = root.classList.contains('light-mode');
        localStorage.setItem('prayerly-theme', isLight ? 'light' : 'dark');
        updateThemeColor();
        updateDownloadLink();
        requestAnimationFrame(function() {
          requestAnimationFrame(function() { overlay.style.opacity = '0'; });
        });
        setTimeout(function() {
          overlay.remove();
          root.classList.remove('theme-transitioning');
        }, 400);
        if (window.goatcounter) {
          window.goatcounter.count({
            path: '/theme/' + (isLight ? 'light' : 'dark'),
            title: 'Theme toggle',
            event: true,
          });
        }
      });

      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        if (localStorage.getItem('prayerly-theme')) return;
        if (e.matches) {
          root.classList.remove('light-mode');
        } else {
          root.classList.add('light-mode');
        }
        updateThemeColor();
      });

      // Sync theme-color meta and download link on bfcache restore
      // (the <head> script already handles the light-mode class toggle)
      window.addEventListener('pageshow', function(e) {
        if (e.persisted) {
          updateThemeColor();
          updateDownloadLink();
        }
      });

      updateThemeColor();
    })();
  </script>

  <!-- GoatCounter Analytics -->
  <script data-goatcounter="https://hasan1239.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>
